@page "/TierLists"
@using MediatR
@using ScoreTracker.Application.Queries
@using ScoreTracker.Domain.Enums
@using ScoreTracker.Domain.Models
@using ScoreTracker.Domain.ValueTypes
@using ScoreTracker.Application.Commands
@using ScoreTracker.Domain.Records
@using ScoreTracker.Web.Components
@using ScoreTracker.Domain.SecondaryPorts
@using ChartType = ScoreTracker.Domain.Enums.ChartType

<PageTitle>Record Attempt</PageTitle>


@inject IMediator Mediator
@inject ICurrentUserAccessor CurrentUser;

<MudGrid>
    <MudItem xs="12" sm="6">
        <MudSelect T="int" AdornmentIcon="@Icons.Filled.Bolt" Label="Difficulty Level" Value="_difficultyFilter" ValueChanged="@(d=>UpdateSelection(d,_chartTypeFilter))" Disabled="_chartTypeFilter==ChartType.CoOp.ToString()">
            @foreach (var level in Enumerable.Range(DifficultyLevel.Min,DifficultyLevel.Max))
            {
                <MudSelectItem T="int" Value="@level">@level</MudSelectItem>
            }
        </MudSelect>
    </MudItem>
    <MudItem xs="12" sm="6">
        <MudSelect T="string" AdornmentIcon="@Icons.Filled.Category" Label="Chart Type" Value="_chartTypeFilter" ValueChanged="@(c=>UpdateSelection(_difficultyFilter,c))">
            @foreach (var type in Enum.GetValues<ChartType>())
            {
                @if (type == ChartType.CoOp)
                {
                    continue;
                }
                <MudSelectItem T="string" Value="@type.ToString()">@type.ToString()</MudSelectItem>
            }
        </MudSelect>
    </MudItem>
</MudGrid>
<TierListSection Charts="_underratedCharts" Name="1+ Level Harder" OutlineColor="@Colors.Red.Darken1" Passes="_passes" ShowVideo="ShowVideo" Videos="_videos" OnEdit="EditChart"></TierListSection>
<TierListSection Charts="_veryHardCharts" Name="Very Hard" OutlineColor="@Colors.Orange.Darken1" Passes="_passes" ShowVideo="ShowVideo" Videos="_videos" OnEdit="EditChart"></TierListSection>
<TierListSection Charts="_hardCharts" Name="Hard" OutlineColor="@Colors.Yellow.Darken1" Passes="_passes" ShowVideo="ShowVideo" Videos="_videos" OnEdit="EditChart"></TierListSection>
<TierListSection Charts="_mediumCharts" Name="Medium" OutlineColor="@Colors.Grey.Darken1" Passes="_passes" ShowVideo="ShowVideo" Videos="_videos" OnEdit="EditChart"></TierListSection>
<TierListSection Charts="_easyCharts" Name="Easy" OutlineColor="@Colors.Cyan.Darken1" Passes="_passes" ShowVideo="ShowVideo" Videos="_videos" OnEdit="EditChart"></TierListSection>
<TierListSection Charts="_veryEasyCharts" Name="Very Easy" OutlineColor="@Colors.Blue.Darken1" Passes="_passes" ShowVideo="ShowVideo" Videos="_videos" OnEdit="EditChart"></TierListSection>
<TierListSection Charts="_overratedCharts" Name="1+ Level Easier" OutlineColor="@Colors.Purple.Darken1" Passes="_passes" ShowVideo="ShowVideo" Videos="_videos" OnEdit="EditChart"></TierListSection>

<MudDialog @bind-IsVisible="_showEditDialog">
    <DialogContent>
        @if (_selectedChartId != Guid.Empty)
        {
            <EditChartGrid ShowChartName="true" ChartId="_selectedChartId" NewAttemptRecorded="AttemptRegistered"></EditChartGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudSpacer></MudSpacer>
        <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Filled.Close" OnClick="() => _showEditDialog = false">Close</MudButton>
    </DialogActions>
</MudDialog>
<MudDialog @bind-IsVisible="_showVideoDialog">
    <DialogContent>
        <iframe class="video"
                id="chartVideoFrame"
                src="@(_currentVideo + "?autoplay=1")"
                allow="autoplay; encrypted-media"
                allowfullscreen></iframe>
    </DialogContent>

    <DialogActions>
        <MudSpacer></MudSpacer>
        <MudTooltip Text="Report Low Quality, Broken, or Incorrect Video">
            <MudButton Href="mailto:sharkingbird@gmail.com" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Filled.Report">Report Video</MudButton>
        </MudTooltip>
        <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Filled.Close" OnClick="()=>_showVideoDialog=false">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private int _difficultyFilter = 18;
    private string _chartTypeFilter = ChartType.Double.ToString();
    private ICollection<Chart> _overratedCharts = Array.Empty<Chart>();
    private ICollection<Chart> _veryEasyCharts = Array.Empty<Chart>();
    private ICollection<Chart> _easyCharts = Array.Empty<Chart>();
    private ICollection<Chart> _mediumCharts = Array.Empty<Chart>();
    private ICollection<Chart> _hardCharts = Array.Empty<Chart>();
    private ICollection<Chart> _veryHardCharts = Array.Empty<Chart>();
    private ICollection<Chart> _underratedCharts = Array.Empty<Chart>();
    private IDictionary<Guid, string> _videos = new Dictionary<Guid, string>();
    private bool _showVideoDialog = false;
    private bool _showEditDialog = false;
    private string _currentVideo = "";
    private ISet<Guid> _passes = new HashSet<Guid>();
    private Guid _selectedChartId = Guid.Empty;

    private void AttemptRegistered(Chart chart, ChartAttempt attempt)
    {
        switch (attempt.IsBroken)
        {
            case true when _passes.Contains(chart.Id):
                _passes.Remove(chart.Id);
                break;
            case false when !_passes.Contains(chart.Id):
                _passes.Add(chart.Id);
                break;
        }
        StateHasChanged();
    }
    private void EditChart(Guid chartId)
    {
        _selectedChartId = chartId;
        _showEditDialog = true;
        StateHasChanged();
    }
    private void ShowVideo(string url)
    {
        _showVideoDialog = true;
        _currentVideo = url;
        StateHasChanged();
    }
    
    protected override async Task OnInitializedAsync()
    {
        _videos = (await Mediator.Send(new GetChartVideosQuery())).ToDictionary(cv => cv.ChartId,cv=>cv.VideoUrl.ToString());
        if (CurrentUser.IsLoggedIn)
        {
            var attempts = await Mediator.Send(new GetBestChartAttemptsQuery(CurrentUser.User.Id));
            _passes = attempts.Where(a => !(a.BestAttempt?.IsBroken??true)).Select(a => a.Chart.Id).Distinct().ToHashSet();
        }
        await UpdateSelection(_difficultyFilter, _chartTypeFilter);
    }

    private async Task UpdateSelection(int difficulty, string chartType)
    {
        _difficultyFilter = difficulty;
        _chartTypeFilter = chartType;
        var charts = await Mediator.Send(new GetChartsQuery(difficulty,Enum.Parse<ChartType>(chartType)));
        var ratings = (await Mediator.Send(new GetChartRatingsQuery(difficulty, Enum.Parse<ChartType>(chartType)))).ToDictionary(c => c.ChartId);

        _overratedCharts = new List<Chart>();
        _veryEasyCharts = new List<Chart>();
        _easyCharts = new List<Chart>();
        _mediumCharts = new List<Chart>();
        _hardCharts = new List<Chart>();
        _veryHardCharts = new List<Chart>();
        _underratedCharts = new List<Chart>();

        foreach (var chart in charts.OrderByDescending(c=>ratings.ContainsKey(c.Id)?ratings[c.Id].Difficulty:c.Level+.5))
        {
            if (!ratings.ContainsKey(chart.Id))
            {
                _mediumCharts.Add(chart);
                continue;
            }
            var diff = ratings[chart.Id].Difficulty - chart.Level - .5;
            switch (diff)
            {
                case < -1:
                    _overratedCharts.Add(chart);
                    break;
                case < -.5:
                    _veryEasyCharts.Add(chart);
                    break;
                case < -.25:
                    _easyCharts.Add(chart);
                    break;
                case <= .25:
                    _mediumCharts.Add(chart);
                    break;
                case <= .5:
                    _hardCharts.Add(chart);
                    break;
                case < 1.0:
                    _veryHardCharts.Add(chart);
                    break;
                default:
                    _underratedCharts.Add(chart);
                    break;
            }

        }
    }

}
