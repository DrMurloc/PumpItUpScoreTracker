@page "/PhoenixCalculator"

@using ScoreTracker.Web.Services.Contracts
@using ScoreTracker.Domain.Records
@using ScoreTracker.Web.Dtos
@using ScoreTracker.Domain.Enums

<PageTitle>Phoenix Calculator</PageTitle>

<MudImage Src="https://piuimages.arroweclip.se/PhoenixBanner.png" Style="width:95%; max-width:800px;"></MudImage>
<MudGrid>
    <MudItem xs="12" sm="6">
        <MudTextField T="int" MaxLength="5" InputType="InputType.Number" Label="Perfects" Value="_perfects" ValueChanged="n=>SetScore(n,_greats,_goods,_bads,_misses,_maxCombo)" Immediate="true" DebounceInterval="200"></MudTextField>
    </MudItem>
    <MudItem xs="12" sm="6">
        <MudTextField T="int" MaxLength="5" InputType="InputType.Number" Label="Greats" Value="_greats" ValueChanged="n=>SetScore(_perfects,n,_goods,_bads,_misses,_maxCombo)" Immediate="true" DebounceInterval="200"></MudTextField>
    </MudItem>
    <MudItem xs="12" sm="6">
        <MudTextField T="int" MaxLength="5" InputType="InputType.Number" Label="Goods" Value="_goods" ValueChanged="n=>SetScore(_perfects,_greats,n,_bads,_misses,_maxCombo)" Immediate="true" DebounceInterval="200"></MudTextField>
    </MudItem>
    <MudItem xs="12" sm="6">
        <MudTextField T="int" MaxLength="5" InputType="InputType.Number" Label="Bads" Value="_bads" ValueChanged="n=>SetScore(_perfects,_greats,_goods,n,_misses,_maxCombo)" Immediate="true" DebounceInterval="200"></MudTextField>
    </MudItem>
    <MudItem xs="12" sm="6">
        <MudTextField T="int" MaxLength="5" InputType="InputType.Number" Label="Misses" Value="_misses" ValueChanged="n=>SetScore(_perfects,_greats,_goods,_bads,n,_maxCombo)" Immediate="true" DebounceInterval="200"></MudTextField></MudItem>
    <MudItem xs="12" sm="6">
        <MudTextField T="int" MaxLength="5" InputType="InputType.Number" Label="Max Combo" Value="_maxCombo" ValueChanged="n=>SetScore(_perfects,_greats,_goods,_bads,_misses,n)" Immediate="true" DebounceInterval="200"></MudTextField>
    </MudItem>
    <MudItem xs="12">
        <MudText>
            <b>Score:</b> @Score.CalculatePhoenixScore
        </MudText>
        <MudText>
            <b>Letter:</b> @Score.LetterGrade.GetName()
        </MudText>
        <MudText>
            <b>Plate:</b> @Score.PlateText
        </MudText>

        @if (Score.IsValid)
        {
            <MudText>
                <b>Next Letter:</b> @Score.NextLetterGrade()
            </MudText>

            <MudText><b>Greats Score Loss:</b> @Score.GreatLoss</MudText>

            <MudText><b>Goods Score Loss:</b> @Score.GoodLoss</MudText>

            <MudText><b>Bads Score Loss:</b> @Score.BadLoss</MudText>

            <MudText><b>Miss Score Loss:</b> @Score.MissLoss</MudText>

            <MudText><b>Combo Score Loss:</b> @Score.ComboLoss</MudText>
            <MudText>(Note: Score loss may be off by 1-4 points due to rounding)</MudText>
            
        }
    </MudItem>

    <MudItem xs="12">

        @if (_showDistribution)
        {

            <ApexChart TItem="JudgementAllocation"
                   Title="Score Distribution">
                <ApexPointSeries TItem="JudgementAllocation"
                                 Items="_yourAllocations"
                                 Name="Your Spread"
                                 SeriesType="SeriesType.Bar"
                                 XValue="@(e => e.Type)"
                                 YAggregate="@(e => e.Sum(z=>z.Count))"
                                 ShowDataLabels />

                <ApexPointSeries TItem="JudgementAllocation"
                                 Items="_averageAllocation"
                                 Name="Average Spread For This Score"
                                 SeriesType="SeriesType.Bar"
                             XValue="@(e => e.Type)"
                             YAggregate="@(e => e.Sum(z=>z.Count))"
                                 ShowDataLabels />
            </ApexChart>
        }
        else
        {
            <MudButton Color="Color.Primary" Disabled="!Score.IsValid" Variant="Variant.Outlined" OnClick="ShowDistribution">Show Score Distribution</MudButton>
        }
    </MudItem>
</MudGrid>
<br/>
<br/>
<MudText>
    Shout out to MR_WEQ for reverse engineering this score formula!<br/>
</MudText>

<MudImage Src="https://piuimages.arroweclip.se/PhoenixFormula.jpg" Style="max-width:85vw; width:auto;"></MudImage>
<br/>
<MudText>
    Note that Letter Grade and Plate Text formulas were pulled from the <MudButton Color="Color.Primary" Href="https://namu.wiki/w/%ED%8E%8C%ED%94%84%20%EC%9E%87%20%EC%97%85%202023%20PHOENIX" Target="_blank">Korean PIU Wikipedia</MudButton>, it is possible for there to be misalignment with actual game logic:<br />
    <br/><br/>
    @foreach (var grade in Enum.GetValues<PhoenixLetterGrade>().OrderByDescending(g => (int)g.GetMinimumScore()))
    {
        <span>@grade.GetName(): @grade.GetMinimumScore() ~ @grade.GetMaximumScore() points</span><br/>
    }
    Perfect Game: All Perfect (previous SSS)<br/>
    Ultimate Game: All Perfect + Great (Previous SS) <br/>
    Extreme Game: All Perfect + Great + Good <br/>
    Superb Game: No Miss (previous S)<br/>
    Marvelous Game: 5 misses or less<br/>
    Talented Game: 10 misses or less<br/>
    Fair Game: Less than or Equal to 20 misses<br/>
    Rough Game: Over 20 misses
</MudText>
@inject ISnackbar Snackbar;
@inject ILogger<PhoenixCalculator> Logger;
@code
{
    private ApexChart<ScoreDistributionDto> _distributionChart;

    private sealed record JudgementAllocation(string Type, int Count)
    {

    }
    private JudgementAllocation[] _averageAllocation = Array.Empty<JudgementAllocation>();
    private JudgementAllocation[] _yourAllocations = Array.Empty<JudgementAllocation>();

    private bool _showDistribution = false;
    private Task SetScore(int perfects, int greats, int goods, int bads, int misses, int maxCombo)
    {
        _showDistribution = false;
        _perfects = Math.Abs(perfects);
        _greats = Math.Abs(greats);
        _goods = Math.Abs(goods);
        _bads = Math.Abs(bads);
        _misses = Math.Abs(misses);
        _maxCombo = Math.Abs(maxCombo);
        Score = new(_perfects, _greats, _goods, _bads, _misses, _maxCombo);
        return Task.CompletedTask;

    }

    private Task ShowDistribution()
    {
        var scoreNoCombo = new ScoreScreen(_perfects, _greats, _goods, _bads, _misses, 0).CalculatePhoenixScore;
        var distribution = ScoreDistributionDto.Get(scoreNoCombo);
        var averagePerfect = distribution.AvgPerfect;
        var averageGreat = distribution.AvgGreat;
        var averageGood = distribution.AvgGood;
        var averageBad = distribution.AvgBad;
        var averageMiss = distribution.AvgMiss;
        var scalingRatio = Score.TotalCount / (double)(averagePerfect + averageGreat + averageGood + averageBad + averageMiss);
        _averageAllocation = new JudgementAllocation[]
        {
            new("Perfects", (int)(averagePerfect*scalingRatio)),
            new("Greats", (int)(averageGreat*scalingRatio)),
            new("Goods", (int)(averageGood*scalingRatio)),
            new("Bads", (int)(averageBad*scalingRatio)),
            new("Misses",(int)(averageMiss*scalingRatio))
        };
        _yourAllocations = new JudgementAllocation[]
        {

            new("Perfects", _perfects),
            new("Greats", _greats),
            new("Goods",_goods),
            new("Bads",_bads),
            new("Misses", _misses)
        };

        _showDistribution = true;
        return Task.CompletedTask;

    }
    public IEnumerable<ScoreDistributionDto> ScoreDistributions = ScoreDistributionDto.DefaultList;
    private int _perfects = 0;
    private int _greats = 0;
    private int _goods = 0;
    private int _bads = 0;
    private int _misses = 0;
    private int _maxCombo = 0;
    private ScoreScreen Score = new (0, 0, 0, 0, 0, 0);
    


}
